<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Neural Network Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-badge.loaded {
            background: #10b981;
            color: white;
        }

        .status-badge.not-loaded {
            background: #ef4444;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .terminal-container {
            grid-column: 1 / -1;
        }

        #terminal {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }

        .log-info {
            color: #61dafb;
        }

        .log-success {
            color: #10b981;
        }

        .log-warning {
            color: #f59e0b;
        }

        .log-error {
            color: #ef4444;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .result-box {
            background: #f3f4f6;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .result-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-box p {
            margin: 5px 0;
            color: #374151;
        }

        .correct {
            color: #10b981;
            font-weight: bold;
        }

        .incorrect {
            color: #ef4444;
            font-weight: bold;
        }

        .test-results {
            margin-top: 15px;
        }

        .test-item {
            background: #f9fafb;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .test-item.correct {
            border-left-color: #10b981;
        }

        .test-item.incorrect {
            border-left-color: #ef4444;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }

        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† Neural Network - Addition Trainer</h1>
            <p>
                <span id="statusBadge" class="status-badge not-loaded">‚ùå Mod√®le non charg√©</span>
            </p>
        </header>

        <div class="grid">
            <!-- Entra√Ænement -->
            <div class="card">
                <h2>üöÄ Entra√Ænement</h2>
                <div class="input-group">
                    <label for="epochs">√âpoques :</label>
                    <input type="number" id="epochs" value="50" min="1" max="1000">
                </div>
                <div class="input-group">
                    <label for="samples">√âchantillons :</label>
                    <input type="number" id="samples" value="5000" min="100" max="100000">
                </div>
                <button onclick="startTraining()">‚ñ∂Ô∏è D√©marrer l'entra√Ænement</button>
                <button onclick="stopTraining()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">‚èπÔ∏è Arr√™ter l'entra√Ænement</button>
                <button onclick="saveModel()">üíæ Sauvegarder le mod√®le</button>
                <button onclick="loadModel()">üìÇ Charger le mod√®le</button>
                <button onclick="downloadModel()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üì• T√©l√©charger le mod√®le</button>
                <button onclick="document.getElementById('importFile').click()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">üì§ Importer le mod√®le</button>
                <input type="file" id="importFile" style="display: none;" onchange="importModel(this)">
                <button onclick="deleteModel()" style="background: linear-gradient(135deg, #ef4444 0%, #b91d1d 100%);">üóëÔ∏è Supprimer le mod√®le</button>
            </div>

            <!-- Pr√©diction -->
            <div class="card">
                <h2>üî¢ Calculer</h2>
                <div class="input-group">
                    <label for="expression">Expression (ex: 42+58) :</label>
                    <input type="text" id="expression" placeholder="123+456" value="42+58">
                </div>
                <button onclick="predict()">‚ú® Calculer</button>
                
                <div id="predictionResult"></div>
            </div>

            <!-- Tests -->
            <div class="card">
                <h2>üß™ Tests</h2>
                <div class="input-group">
                    <label for="numTests">Nombre de tests :</label>
                    <input type="number" id="numTests" value="10" min="1" max="100">
                </div>
                <button onclick="runTests()">üéØ Lancer les tests</button>
                
                <div id="testResults"></div>
            </div>

            <!-- Informations -->
            <div class="card">
                <h2>üìä Informations</h2>
                <div id="modelInfo">
                    <p>Chargement...</p>
                </div>
            </div>

            <!-- Terminal en temps r√©el -->
            <div class="card terminal-container">
                <h2>üíª Terminal (Live)</h2>
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;

        // Connexion au stream SSE
        function connectTerminal() {
            eventSource = new EventSource('/api/terminal-stream');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.ping) return;
                
                const terminal = document.getElementById('terminal');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${data.level}`;
                
                logEntry.innerHTML = `<span class="log-timestamp">[${data.timestamp}]</span>${escapeHtml(data.message)}`;
                
                terminal.appendChild(logEntry);
                terminal.scrollTop = terminal.scrollHeight;
            };

            eventSource.onerror = function() {
                setTimeout(connectTerminal, 5000);
            };
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // D√©marrer l'entra√Ænement
        async function startTraining() {
            const epochs = document.getElementById('epochs').value;
            const samples = document.getElementById('samples').value;
            
            const terminal = document.getElementById('terminal');
            const startLog = document.createElement('div');
            startLog.className = 'log-entry log-info';
            startLog.innerHTML = `<span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>üöÄ Envoi de la requ√™te d'entra√Ænement...`;
            terminal.appendChild(startLog);

            try {
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ epochs: parseInt(epochs), samples: parseInt(samples) })
                });

                const data = await response.json();
                const confirmLog = document.createElement('div');
                confirmLog.className = 'log-entry log-success';
                confirmLog.innerHTML = `<span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>‚úÖ Entra√Ænement d√©marr√© (√©poques: ${epochs}, √©chantillons: ${samples})`;
                terminal.appendChild(confirmLog);
                terminal.scrollTop = terminal.scrollHeight;
            } catch (error) {
                const errorLog = document.createElement('div');
                errorLog.className = 'log-entry log-error';
                errorLog.innerHTML = `<span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>‚ùå Erreur: ${error.message}`;
                terminal.appendChild(errorLog);
            }
        }

        // Arr√™ter l'entra√Ænement
        async function stopTraining() {
            const terminal = document.getElementById('terminal');
            try {
                const response = await fetch('/api/stop-training', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    const stopLog = document.createElement('div');
                    stopLog.className = 'log-entry log-warning';
                    stopLog.innerHTML = `<span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>üõë Demande d'arr√™t envoy√©e...`;
                    terminal.appendChild(stopLog);
                    terminal.scrollTop = terminal.scrollHeight;
                }
            } catch (error) {
                console.error("Erreur lors de l'arr√™t:", error);
            }
        }

        // Pr√©diction
        async function predict() {
            const expression = document.getElementById('expression').value;
            const resultDiv = document.getElementById('predictionResult');

            resultDiv.innerHTML = '<div class="loader"></div>';

            const response = await fetch('/api/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ expression })
            });

            const data = await response.json();

            if (data.error) {
                resultDiv.innerHTML = `<div class="result-box"><p class="incorrect">‚ùå ${data.error}</p></div>`;
                return;
            }

            // Extraire le r√©sultat final
            let finalResult = '';
            if (data.decomposition.includes('donc le resultat est ')) {
                finalResult = data.decomposition.split('donc le resultat est ').pop().trim().split(' ')[0];
            } else {
                finalResult = data.final_result;
            }

            const isCorrect = finalResult === String(data.expected) ? 'correct' : 'incorrect';
            const icon = finalResult === String(data.expected) ? '‚úÖ' : '‚ùå';

            resultDiv.innerHTML = `
                <div class="result-box">
                    <h3>R√©sultat :</h3>
                    <p><strong>Expression :</strong> ${data.expression}</p>
                    <p><strong>R√©sultat pr√©dit :</strong> ${finalResult}</p>
                    <p><strong>R√©sultat attendu :</strong> ${data.expected}</p>
                    <p class="${isCorrect}">${icon} ${finalResult === String(data.expected) ? 'Correct' : 'Incorrect'}</p>
                    <p><strong>D√©composition :</strong><br>${data.decomposition}</p>
                </div>
            `;
        }

        // Tests
        async function runTests() {
            const numTests = document.getElementById('numTests').value;
            const resultDiv = document.getElementById('testResults');

            resultDiv.innerHTML = '<div class="loader"></div>';

            const response = await fetch('/api/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ num_tests: parseInt(numTests) })
            });

            const data = await response.json();

            let html = `<div class="result-box"><h3>üìä R√©sultats : ${data.correct}/${data.total} (${data.accuracy.toFixed(1)}%)</h3></div>`;
            html += '<div class="test-results">';

            data.results.forEach(result => {
                const status = result.correct ? 'correct' : 'incorrect';
                const icon = result.correct ? '‚úÖ' : '‚ùå';
                
                html += `
                    <div class="test-item ${status}">
                        ${icon} <strong>${result.expression}</strong> = ${result.predicted} 
                        (attendu: ${result.expected})
                    </div>
                `;
            });

            html += '</div>';
            resultDiv.innerHTML = html;
        }

        // Sauvegarder
        async function saveModel() {
            const response = await fetch('/api/save', { method: 'POST' });
            const data = await response.json();
            alert(data.success ? '‚úÖ Mod√®le sauvegard√©' : '‚ùå Erreur de sauvegarde');
        }

        // Charger
        async function loadModel() {
            const response = await fetch('/api/load', { method: 'POST' });
            const data = await response.json();
            alert(data.success ? '‚úÖ Mod√®le charg√©' : '‚ùå Erreur de chargement');
            updateStatus();
        }

        // T√©l√©charger
        function downloadModel() {
            window.location.href = '/api/download';
        }

        // Importer
        async function importModel(input) {
            if (!input.files || input.files.length === 0) return;
            
            const formData = new FormData();
            formData.append('file', input.files[0]);
            
            const terminal = document.getElementById('terminal');
            const importLog = document.createElement('div');
            importLog.className = 'log-entry log-info';
            importLog.innerHTML = `<span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>üì§ Importation du mod√®le en cours...`;
            terminal.appendChild(importLog);

            try {
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Mod√®le import√© avec succ√®s');
                    updateStatus();
                } else {
                    alert('‚ùå Erreur: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erreur r√©seau: ' + error.message);
            } finally {
                input.value = ''; // R√©initialiser l'input
            }
        }

        // Supprimer
        async function deleteModel() {
            if (!confirm('Voulez-vous vraiment supprimer le mod√®le et son historique ?')) return;
            const response = await fetch('/api/delete', { method: 'POST' });
            const data = await response.json();
            if (data.success) {
                alert('‚úÖ Mod√®le supprim√©');
                updateStatus();
            } else {
                alert('‚ùå Erreur: ' + data.error);
            }
        }

        // Mise √† jour du statut
        async function updateStatus() {
            const response = await fetch('/api/status');
            const data = await response.json();

            const badge = document.getElementById('statusBadge');
            if (data.model_loaded) {
                badge.className = 'status-badge loaded';
                badge.textContent = '‚úÖ Mod√®le charg√©';
            } else {
                badge.className = 'status-badge not-loaded';
                badge.textContent = '‚ùå Mod√®le non charg√©';
            }

            const infoDiv = document.getElementById('modelInfo');
            infoDiv.innerHTML = `
                <p><strong>Device :</strong> ${data.device}</p>
                <p><strong>Vocabulaire :</strong> ${data.vocab_size} tokens</p>
                <p><strong>S√©quence max :</strong> ${data.max_seq_length}</p>
                <p><strong>√âpoques :</strong> ${data.training_epochs}</p>
            `;
        }

        // Initialisation
        connectTerminal();
        updateStatus();
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>
